nextflow_pipeline {

    name "Test pipeline"
    script "../main.nf"
    tag "pipeline"
    tag "test"
    profile "test"

    test("-profile test") {

        when {
            params {
                outdir = "$outputDir"
            }
        }

        then {

            def stable_name_all = getAllFilesFromDir(params.outdir, relative: true, includeDir: true, ignore: ['pipeline_info/*.{html,json,txt}'])

             //BBDuk
            def stable_content_bbduk          = getAllFilesFromDir("$outputDir/bbduk", relative: true, includeDir: false, ignore: null, ignoreFile: 'tests/.nftignore', include: ['*','**/*'])

            //centrifuge
            def stable_content_centrifuge     = getAllFilesFromDir("$outputDir/centrifuge", relative: true, includeDir: false, ignore: null, ignoreFile: 'tests/.nftignore', include: ['*','**/*'])

            //diamond
            def stable_content_diamond        = getAllFilesFromDir("$outputDir/diamond", relative: true, includeDir: false, ignore: null, ignoreFile: 'tests/.nftignore', include: ['*','**/*'])

            //fastp
            def stable_content_fastp        = getAllFilesFromDir("$outputDir/fastp", relative: true, includeDir: false, ignore: null, ignoreFile: 'tests/.nftignore', include: ['*','**/*'])

            //ganon
            def stable_content_ganon        = getAllFilesFromDir("$outputDir/ganon", relative: true, includeDir: false, ignore: null, ignoreFile: 'tests/.nftignore', include: ['*','**/*'])


            assertAll(
                { assert workflow.success},
                { assert snapshot(
                    // pipeline versions.yml file for multiqc from which Nextflow version is removed because we test pipelines on multiple Nextflow versions
                    removeNextflowVersion("$outputDir/pipeline_info/nf_core_taxprofiler_software_mqc_versions.yml"),
                ).match() },

                { assert new File("$outputDir/pipeline_info/nf_core_taxprofiler_software_mqc_versions.yml").exists() },
                { assert new File("$outputDir/multiqc/multiqc_report.html").exists() },

                { assert snapshot ( stable_name_all ).match("all_files") },
                { assert snapshot( file("$outputDir/bbduk/2613_ERR5766181.bbduk.log").text.contains("Reads Processed:"),
                                file("$outputDir/bbduk/2612_ERR5766180.bbduk.log").text.contains("Reads Processed:"),
                                file("$outputDir/bbduk/2612_ERR5766176.bbduk.log").text.contains("Reads Processed:"),
                                file("$outputDir/bbduk/2612_ERR5766176_B.bbduk.log").text.contains("Reads Processed:"),
                                stable_content_bbduk).match("bbduk")},
                { assert snapshot (path("$outputDir/bowtie2/align")).match("bowtie2")},
                { assert snapshot (path("$outputDir/bracken")).match("bracken")},
                { assert snapshot( file("$outputDir/centrifuge/db3/2612_db3.centrifuge.report.txt").text.contains("Homo sapiens"),
                                file("$outputDir/centrifuge/db3/2612_db3.centrifuge.results.txt").text.contains("ERR5766180.602"),
                                file("$outputDir/centrifuge/db3/2612_db3.centrifuge.txt").text.contains("Centrifuge"),
                                file("$outputDir/centrifuge/db3/2613_db3.centrifuge.report.txt").text.contains("Homo sapiens"),
                                file("$outputDir/centrifuge/db3/2613_db3.centrifuge.results.txt").text.contains("ERR5766181.1"),
                                file("$outputDir/centrifuge/db3/2613_db3.centrifuge.txt").text.contains("Homo sapiens"),
                                file("$outputDir/centrifuge/centrifuge_db3_combined_reports.txt").text.contains("Homo sapiens"),
                                stable_content_centrifuge).match("centrifuge") },
                { assert snapshot( file("$outputDir/diamond/db1/2611_db1.diamond.log").text.contains("queries aligned"),
                                file("$outputDir/diamond/db1/2611_db1.diamond.tsv").text.contains("ERR5766174.77"),
                                file("$outputDir/diamond/db1/2612_db1.diamond.log").text.contains("queries aligned"),
                                file("$outputDir/diamond/db1/2612_db1.diamond.tsv").text.contains("ERR5766180.773"),
                                file("$outputDir/diamond/db1/2613_db1.diamond.log").text.contains("queries aligned"),
                                file("$outputDir/diamond/db1/2613_db1.diamond.tsv").text.contains("ERR5766181.59"),
                                file("$outputDir/diamond/db2/2614_db2.diamond.log").text.contains("queries aligned"),
                                file("$outputDir/diamond/db2/2614_db2.diamond.tsv").text.contains("ERR3201952.882919"),
                                file("$outputDir/diamond/db2/ERR3201952_db2.diamond.log").text.contains("queries aligned"),
                                file("$outputDir/diamond/db2/ERR3201952_db2.diamond.tsv").text.contains("ERR3201952.882919 "),
                                file("$outputDir/diamond/db3/2611_db3.diamond.log").text.contains("queries aligned"),
                                file("$outputDir/diamond/db3/2611_db3.diamond.tsv").text.contains("ERR5766174.77"),
                                file("$outputDir/diamond/db3/2612_db3.diamond.log").text.contains("queries aligned"),
                                file("$outputDir/diamond/db3/2612_db3.diamond.tsv").text.contains("ERR5766180.773"),
                                file("$outputDir/diamond/db3/2613_db3.diamond.log").text.contains("queries aligned"),
                                file("$outputDir/diamond/db3/2613_db3.diamond.tsv").text.contains("ERR5766181.59 "),
                                file("$outputDir/diamond/db3/2614_db3.diamond.log").text.contains("queries aligned"),
                                file("$outputDir/diamond/db3/2614_db3.diamond.tsv").text.contains("ERR3201952.882919 "),
                                file("$outputDir/diamond/db3/ERR3201952_db3.diamond.log").text.contains("queries aligned"),
                                file("$outputDir/diamond/db3/ERR3201952_db3.diamond.tsv").text.contains("ERR3201952.882919 "),
                                stable_content_diamond).match("diamond") },
               { assert snapshot( file("$outputDir/fastp/2612_ERR5766176_B.fastp.json").text.contains("fastp_version"),
                                file("$outputDir/fastp/2612_ERR5766176_B.fastp.log").text.contains("Detecting adapter sequence"),
                                file("$outputDir/fastp/2612_ERR5766176.fastp.json").text.contains("fastp_version"),
                                file("$outputDir/fastp/2612_ERR5766176.fastp.log").text.contains("Detecting adapter sequence"),
                                file("$outputDir/fastp/2612_ERR5766180.fastp.json").text.contains("fastp_version"),
                                file("$outputDir/fastp/2612_ERR5766180.fastp.log").text.contains("Detecting adapter sequence"),
                                file("$outputDir/fastp/2613_ERR5766181.fastp.json").text.contains("fastp_version"),
                                file("$outputDir/fastp/2613_ERR5766181.fastp.log").text.contains("Detecting adapter sequence"),
                                stable_content_fastp).match("fastp") },
                { assert snapshot( file("$outputDir/ganon/db1/2611_db1.ganon.log").text.contains("entries reported"),
                                file("$outputDir/ganon/db1/2611_db1.ganon.rep").text.contains("NC_001148.4"),
                                file("$outputDir/ganon/db1/2611_db1.ganon_report.tre").text.contains("unclassified"),
                                file("$outputDir/ganon/db1/2611_db1.ganon.tre").text.contains("Saccharomyces cerevisiae"),
                                file("$outputDir/ganon/db1/2612_db1.ganon.log").text.contains("entries reported"),
                                file("$outputDir/ganon/db1/2612_db1.ganon.rep").text.contains("NC_001148.4"),
                                file("$outputDir/ganon/db1/2612_db1.ganon_report.tre").text.contains("unclassified"),
                                file("$outputDir/ganon/db1/2612_db1.ganon.tre").text.contains("Saccharomyces cerevisiae"),
                                file("$outputDir/ganon/db1/2613_db1.ganon.log").text.contains("entries reported"),
                                file("$outputDir/ganon/db1/2613_db1.ganon.rep").text.contains("NC_001148.4"),
                                file("$outputDir/ganon/db1/2613_db1.ganon_report.tre").text.contains("unclassified"),
                                file("$outputDir/ganon/db1/2613_db1.ganon.tre").text.contains("Saccharomyces cerevisiae"),
                                file("$outputDir/ganon/ganon_db1_combined_reports.txt").text.contains("root"),
                            stable_content_ganon
                        ).match("ganon") },

            )
        }
    }
}


