nextflow_pipeline {

    name "Test pipeline"
    script "../main.nf"
    tag "pipeline"
    tag "test"
    profile "test"

    test("-profile test") {

        when {
            params {
                outdir = "$outputDir"
            }
        }

        then {
                   ///////////////////
            // DOCUMENTATION //
            ///////////////////

            // The contents of each top level results directory should be tested with individually named snapshots.
            // Within each snapshot, there should be two to three distinct variables, that contain the files to be tested.
            //    - stable_name_<dir> is for files with variable md5sums (i.e. content) so only names will be compared
            //    - stable_content_<dir> is for files with stable md5sums (i.e. content) so md5sums will be compared
            //    - bams_<dir> is for BAM files, where the headerMD5 is checked for stability (since the content can be unstable)
            // If a directory is fully stable, you can drop `stable_name_*`
            // If a directory contains no BAMs, you can drop `bams_*`

            // Generate with: nf-test test --tag test --profile=+singularity --verbose --debug --update-snapshot
            // Test with:     nf-test test --tag test --profile=+singularity

            //////////////////////
            // DEFINE VARIABLES //
            //////////////////////

            // Define exclusion patterns for files with unstable contents
            // NOTE: When a section needs more than a couple of small patterns, consider adding a variable to store the patterns here
            //       This is particularly important if the patterns excluded in the stable content section should be included in the stable name section

            def unstable_patterns_multiqc = [
                '**/multiqc_data/fastqc_top_overrepresented_sequences_table.txt',
                '**/multiqc_data/multiqc_data/BETA-multiqc.parquet',
                '**/multiqc_data/multiqc.log',
                '**/multiqc_data/multiqc_data.json',
                '**/multiqc_data/multiqc_sources.txt',
                '**/multiqc_data/multiqc_software_versions.txt',
                '**/multiqc_data/*.txt',
                '**/multiqc_plots/{svg,pdf,png}/*.{svg,pdf,png}',
                '**/multiqc_report.html',
                '**/multiqc_data/*.txt'
            ]

              // Check that no files are missing/added
            // Command legend: Result directory to index, includeDir: include dirs?, ignore: exclude patterns                   , ignoreFile: exclude pattern list, include: include patterns
            def stable_name_all        = getAllFilesFromDir("$outputDir/", relative: true, includeDir: false, ignore: ['pipeline_info/*.{html,json,txt}'], ignoreFile: null, include: ['*', '**/*'])

            //BBDuk
            def stable_content_bbduk   = getAllFilesFromDir("$outputDir/bbduk", relative: true, includeDir: false, ignore: ['*.log'], ignoreFile: null, include: ['*','**/*'])
            def stable_name_bbduk      = getAllFilesFromDir("$outputDir/bbduk", relative: true, includeDir: false, ignore: null , ignoreFile: null, include: ['**/*.fastq.gz'] )

            //DIAMOND
            def stable_content_diamond = getAllFilesFromDir("$outputDir/diamond", relative: true, includeDir: false, ignore: ['*/*.{tsv,log,txt}'], ignoreFile: null, include: ['*','**/*'])
            def stable_name_diamond    = getAllFilesFromDir("$outputDir/diamond", relative: true, includeDir: false, ignore: null , ignoreFile: null, include: ['**/*.{tsv,log,txt}'] )


            assertAll(
                { assert workflow.success},
                { assert snapshot(
                    // Number of successful tasks
                    workflow.trace.succeeded().size(),
                    // pipeline versions.yml file for multiqc from which Nextflow version is removed because we test pipelines on multiple Nextflow versions
                    removeNextflowVersion("$outputDir/pipeline_info/nf_core_taxprofiler_software_mqc_versions.yml"),
                    // All stable path name, with a relative path
                   // stable_name,
                    // All files with stable contents
                    //stable_path
                ).match() },
                    // This checks that there are no missing or additional output files.
                // Also a good starting point to look at all the files in the output folder than need to be checked in subsequent sections.
                { assert snapshot ( stable_name_all ).match("all_files") },

                // Checking changes to contents of each section
                // NOTE: Keep the order of the sections in the alphanumeric order of the output directories.
                //    Each section should first check stable_content, stable_name second (if applicable).
                { assert snapshot ( stable_content_bbduk, stable_name_bbduk ).match("bbduk" ) },
                { assert snapshot ( stable_content_diamond, stable_name_diamond ).match("diamond" ) },
            )
        }
    }
}
