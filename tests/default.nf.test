nextflow_pipeline {

    name "Test pipeline"
    script "../main.nf"
    tag "pipeline"
    tag "test"
    profile "test"

    test("-profile test") {

        when {
            params {
                outdir = "$outputDir"
            }
        }

        then {

            def unstable_patterns_multiqc = [
                '**/multiqc_data/fastqc_top_overrepresented_sequences_table.txt',
                '**/multiqc_data/BETA-multiqc.parquet',
                '**/multiqc_data/multiqc.parquet',
                '**/multiqc_data/multiqc.log',
                '**/multiqc_data/multiqc_data.json',
                '**/multiqc_data/multiqc_sources.txt',
                '**/multiqc_data/multiqc_software_versions.txt',
                '**/multiqc_plots/{svg,pdf,png}/*.{svg,pdf,png}',
                '**/multiqc_report.html',
                '**/multiqc_data/*.txt'
            ]

 	  	    // stable_name: All files + folders in ${params.outdir}/ with a stable name
            def stable_name_all = getAllFilesFromDir(params.outdir, relative: true, includeDir: true, ignore: ['pipeline_info/*.{html,json,txt}'])
            // stable_path: All files in ${params.outdir}/ with stable content
            def stable_path     = getAllFilesFromDir(params.outdir, ignoreFile: 'tests/.nftignore')

             //MultiQC
            def stable_content_multiqc   = getAllFilesFromDir("$outputDir/multiqc", relative: true, includeDir: false, ignore: unstable_patterns_multiqc, ignoreFile: null, include: ['*', '**/*'])
            def stable_name_multiqc      = getAllFilesFromDir("$outputDir/multiqc", relative: true, includeDir: false, ignore: null, ignoreFile: null, include: unstable_patterns_multiqc)

	         //BBDuk
            def stable_content_bbduk     = getAllFilesFromDir("$outputDir/bbduk", relative: true, includeDir: false, ignore: ['*.{log,fastq.gz}'], ignoreFile: null, include: ['*','**/*'])
            def stable_name_bbduk        = getAllFilesFromDir("$outputDir/bbduk", relative: true, includeDir: false, ignore: null , ignoreFile: null, include: ['**/*.{log,fastq.gz}'] )

	          //DIAMOND
            def stable_content_diamond   = getAllFilesFromDir("$outputDir/diamond", relative: true, includeDir: false, ignore: ['*/*.{tsv,log}'], ignoreFile: null, include: ['*','**/*'])
            def stable_name_diamond      = getAllFilesFromDir("$outputDir/diamond", relative: true, includeDir: false, ignore: null , ignoreFile: null, include: ['**/*.{tsv,log}'] )

            //nonpareil
            def stable_content_nonpareil = getAllFilesFromDir("$outputDir/nonpareil", relative: true, includeDir: false, ignore: ['*.{svg,npa}'] , ignoreFile: null, include: ['*','**/*'])
            def stable_name_nonpareil    = getAllFilesFromDir("$outputDir/nonpareil", relative: true, includeDir: false, ignore: null , ignoreFile: null, include: ['**/*.{svg,npa}'] )

            //kraken2
            def stable_content_kraken2   = getAllFilesFromDir("$outputDir/kraken2", relative: true, includeDir: false, ignore: ['**/*.fastq.gz'] , ignoreFile: null, include: ['*','**/*'])
            def stable_name_kraken2      = getAllFilesFromDir("$outputDir/kraken2", relative: true, includeDir: false, ignore: null, ignoreFile: null, include: ['*', '**/*.fastq.gz'])

            //bowtie2
            def stable_name_bowtie2      = getAllFilesFromDir("$outputDir/bowtie2", relative: true, includeDir: false, ignore: null, ignoreFile: null, include: ['*', '**/*'])

            //bracken
            def stable_name_bracken      = getAllFilesFromDir("$outputDir/bracken", relative: true, includeDir: false, ignore: null, ignoreFile: null, include: ['*', '**/*'])

            //centrifuge
            def stable_content_centrifuge   = getAllFilesFromDir("$outputDir/centrifuge", relative: true, includeDir: false, ignore: ['**/*.fastq.gz'] , ignoreFile: null, include: ['*','**/*'])
            def stable_name_centrifuge   = getAllFilesFromDir("$outputDir/centrifuge", relative: true, includeDir: false, ignore: null, ignoreFile: null, include: ['*', '**/*'])

            //fastp
            def stable_content_fastp     = getAllFilesFromDir("$outputDir/fastp", relative: true, includeDir: false, ignore: ['*.{log}'] , ignoreFile: null, include: ['*','**/*'])
            def stable_name_fastp        = getAllFilesFromDir("$outputDir/fastp", relative: true, includeDir: false, ignore: null, ignoreFile: null, include: ['*', '**/*.log'])

            //ganon
            def stable_content_ganon     = getAllFilesFromDir("$outputDir/ganon", relative: true, includeDir: false, ignore: ['**/*.log'] , ignoreFile: null, include: ['*','**/*'])
            def stable_name_ganon        = getAllFilesFromDir("$outputDir/ganon", relative: true, includeDir: false, ignore: null, ignoreFile: null, include: ['*', '**/*.log'])

            //kaiju
            def stable_content_kaiju     = getAllFilesFromDir("$outputDir/kaiju", relative: true, includeDir: false, ignore: ['**/*.tsv'] , ignoreFile: null, include: ['*','**/*'])
            def stable_name_kaiju        = getAllFilesFromDir("$outputDir/kaiju", relative: true, includeDir: false, ignore: null, ignoreFile: null, include: ['*', '**/*.tsv'])

            //kmcp
            def stable_name_kmcp         = getAllFilesFromDir("$outputDir/kmcp", relative: true, includeDir: false, ignore: null, ignoreFile: null, include: ['*', '**/*'])

            // krona
            def stable_content_krona     = getAllFilesFromDir("$outputDir/krona", relative: true, includeDir: false, ignore: ['*.html'] , ignoreFile: null, include: ['*','**/*'])
            def stable_name_krona        = getAllFilesFromDir("$outputDir/krona", relative: true, includeDir: false, ignore: null, ignoreFile: null, include: ['*', '*.html'])

            // metaphlan
            def stable_content_metaphlan = getAllFilesFromDir("$outputDir/metaphlan", relative: true, includeDir: false, ignore: ['**/*.{biom,txt}'] , ignoreFile: null, include: ['*','**/*'])
            def stable_name_metaphlan    = getAllFilesFromDir("$outputDir/metaphlan", relative: true, includeDir: false, ignore: null, ignoreFile: null, include: ['*', '**/*.{biom,txt}'])

            // nanoq
            def stable_name_nanoq        = getAllFilesFromDir("$outputDir/nanoq", relative: true, includeDir: false, ignore: null, ignoreFile: null, include: ['*', '**/*'])

            // porechop_abi
            def stable_content_porechopabi = getAllFilesFromDir("$outputDir/porechop_abi", relative: true, includeDir: false, ignore: ['*.{log}'] , ignoreFile: null, include: ['*','**/*'])
            def stable_name_porechopabi  = getAllFilesFromDir("$outputDir/porechop_abi", relative: true, includeDir: false, ignore: null, ignoreFile: null, include: ['*', '**/*.log'])

            // samtools
            def stable_name_samtools     = getAllFilesFromDir("$outputDir/samtools", relative: true, includeDir: false, ignore: null, ignoreFile: null, include: ['*', '**/*'])

            //taxpasta
            def stable_content_taxpasta  = getAllFilesFromDir("$outputDir/taxpasta", relative: true, includeDir: false, ignore: ['*.{tsv}'], ignoreFile: null, include: ['*', '**/*'])
            def stable_name_taxpasta     = getAllFilesFromDir("$outputDir/taxpasta", relative: true, includeDir: false, ignore: null, ignoreFile: null, include: ['*.{tsv}'])


            assertAll(
                { assert workflow.success},
                { assert snapshot(
                    // pipeline versions.yml file for multiqc from which Nextflow version is removed because we test pipelines on multiple Nextflow versions
                    removeNextflowVersion("$outputDir/pipeline_info/nf_core_taxprofiler_software_mqc_versions.yml"),
                ).match() },

                { assert new File("$outputDir/pipeline_info/nf_core_taxprofiler_software_mqc_versions.yml").exists() },
                { assert new File("$outputDir/multiqc/multiqc_report.html").exists() },

                { assert snapshot ( stable_name_all ).match("all_files") },
		            { assert snapshot ( stable_name_multiqc ).match("multiqc" ) },
                { assert snapshot( file("$outputDir/bbduk/2613_ERR5766181.bbduk.log").text.contains("Reads Processed:"), file("$outputDir/bbduk/2612_ERR5766180.bbduk.log").text.contains("Reads Processed:"),file("$outputDir/bbduk/2612_ERR5766176.bbduk.log").text.contains("Reads Processed:"),file("$outputDir/bbduk/2612_ERR5766176_B.bbduk.log").text.contains("Reads Processed:"),stable_content_bbduk, stable_name_bbduk).match("bbduk")},
                { assert snapshot ( stable_content_diamond, stable_name_diamond, file("$outputDir/diamond/db2/2614_db2.diamond.log").text.contains("133 queries aligned"),file("$outputDir/diamond/db2/2614_db2.diamond.tsv").text.contains("ERR3201952.3404519"),file("$outputDir/diamond/db2/ERR3201952_db2.diamond.log").text.contains("91 queries aligned"),file("$outputDir/diamond/db2/ERR3201952_db2.diamond.tsv").text.contains("ERR3201952.3889254")).match("diamond" ) },
                { assert snapshot ( stable_content_nonpareil, stable_name_nonpareil, file("$outputDir/nonpareil/2612_ERR5766176_B.npa").text.contains("0.00"), file("$outputDir/nonpareil/2612_ERR5766176.npa").text.contains("0.00"),file("$outputDir/nonpareil/2612_ERR5766180.npa").text.contains("0.00"),file("$outputDir/nonpareil/2613_ERR5766181.npa").text.contains("0.00")).match("nonpareil" ) },
                  { assert snapshot (
                        stable_name_kraken2, stable_content_kraken2, file ("$outputDir/kraken2/db2/2613_db2.kraken2.kraken2.report.txt").text.contains("S288C"), file ("$outputDir/kraken2/db2/2611_db2.kraken2.kraken2.report.txt").text.contains("S288C"), file ("$outputDir/kraken2/db2/2612_db2.kraken2.kraken2.report.txt").text.contains("S288C"),
                        file("$outputDir/kraken2/db2/2611_db2.kraken2.classified.fastq.gz").text.contains(">ERR5766174.15494"),file("$outputDir/kraken2/db2/2612_db2.kraken2.classified.fastq.gz").text.contains("@ERR5766180.35963"),file("$outputDir/kraken2/db2/2613_db2.kraken2.classified.fastq.gz").text.contains("@ERR5766181.6866"))
                        .match("kraken2") },
                { assert snapshot ( stable_name_bowtie2, file ("$outputDir/bowtie2/align/2613_ERR5766181.bowtie2.log").text.contains("overall alignment rate"), file ("$outputDir/bowtie2/align/2612_ERR5766176_B.bowtie2.log").text.contains("overall alignment rate"), file ("$outputDir/bowtie2/align/2612_ERR5766176.bowtie2.log").text.contains("overall alignment rate"), file ("$outputDir/bowtie2/align/2612_ERR5766180.bowtie2.log").text.contains("overall alignment rate"),
                        path("$outputDir/bowtie2/align/"))
                        .match("bowtie2" ) },
                { assert snapshot ( stable_name_bracken, file ("$outputDir/bracken/db1/2613_db1.bracken.tsv").text.contains("Homo sapiens"), file ("$outputDir/bracken/db1/2611_db1.bracken.tsv").text.contains("Homo sapiens"), file ("$outputDir/bracken/db1/2612_db1.bracken.tsv").text.contains("Homo sapiens"),
                        path("$outputDir/bracken/db1"))
                        .match("bracken") },
                { assert snapshot ( stable_name_centrifuge, file ("$outputDir/centrifuge/db3/2613_db3.centrifuge.report.txt").text.contains("Eucommia"), file ("$outputDir/centrifuge/db3/2612_db3.centrifuge.report.txt").text.contains("Eucommia"),
                        stable_content_centrifuge)
                        .match("centrifuge") },
                { assert snapshot ( file ("$outputDir/fastp/2613_ERR5766181.fastp.log").text.contains("Read pairs merged"),file ("$outputDir/fastp/2612_ERR5766176_B.fastp.log").text.contains("Read pairs merged"),file ("$outputDir/fastp/2612_ERR5766180.fastp.log").text.contains("Read pairs merged"),stable_content_fastp, stable_name_fastp ).match("fastp") },
                { assert snapshot ( stable_name_ganon, stable_content_ganon, file ("$outputDir/ganon/db1/2613_db1.ganon.tre").text.contains("Saccharomycetales"),file ("$outputDir/ganon/db1/2612_db1.ganon.tre").text.contains("Saccharomycetales"), file ("$outputDir/ganon/db1/2611_db1.ganon.tre").text.contains("Saccharomycetales")).match("ganon") },
                { assert snapshot ( file ("$outputDir/kaiju/db6/2614_db6.kaiju.tsv").text.contains("ERR3201952.3225565"),file ("$outputDir/kaiju/db6/ERR3201952_db6.kaiju.tsv").text.contains("ERR3201952.1159044"),stable_content_kaiju, stable_name_kaiju ).match("kaiju") },
                { assert snapshot ( stable_name_kmcp, file ("$outputDir/kmcp/db1/2613_db1.kmcp.profile").text.contains("NW_024067565.1"),file ("$outputDir/kmcp/db1/2612_db1.kmcp.profile").text.contains("NW_024067565.1"),file ("$outputDir/kmcp/db1/2611_db1.kmcp.profile").text.contains("NW_024067565.1"),
                        path("$outputDir/kmcp/db1"))
                        .match("kmcp") },
                { assert snapshot ( stable_name_krona, stable_content_krona).match("krona" ) },
                { assert snapshot ( stable_name_metaphlan,file ("$outputDir/metaphlan/metaphlan4/2613_metaphlan4.metaphlan_profile.txt").text.contains("SGB4933_group"),file("$outputDir/metaphlan/metaphlan4/2612_metaphlan4.metaphlan_profile.txt").text.contains("p__Firmicutes"),file("$outputDir/metaphlan/metaphlan4/2611_metaphlan4.metaphlan_profile.txt").text.contains("UNCLASSIFIED"),stable_content_metaphlan).match("metaphlan") },
                { assert snapshot ( stable_name_nanoq, file ("$outputDir/nanoq/ERR3201952_ERR3201952_filtered.stats").text.contains("Median read quality"), path("$outputDir/nanoq/")).match("nanoq") },
                { assert snapshot ( file ("$outputDir/porechop_abi/ERR3201952_ERR3201952_porechop_abi.log").text.contains("reads were split"), stable_name_porechopabi, stable_content_porechopabi).match("porechop_abi") },
                { assert snapshot ( stable_name_samtools, file ("$outputDir/samtools/stats/2613_ERR5766181.stats").text.contains("mismatches:"),file ("$outputDir/samtools/stats/2612_ERR5766176_B.stats").text.contains("mismatches:"),file ("$outputDir/samtools/stats/2612_ERR5766176.stats").text.contains("mismatches:"),file ("$outputDir/samtools/stats/2612_ERR5766180.stats").text.contains("mismatches:"),file ("$outputDir/samtools/stats/ERR3201952_ERR3201952.stats").text.contains("mismatches:"),
                        path("$outputDir/samtools/stats/")).match("samtools") },
                { assert snapshot ( stable_name_taxpasta, stable_content_taxpasta, file("$outputDir/taxpasta/metaphlan_metaphlan4.tsv").text.contains("186801")).match("taxpasta") },
            )
        }
    }
}
