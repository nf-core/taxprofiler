nextflow_pipeline {

    name "Test Workflow main.nf"
    script "main.nf"
    tag "test_krakenuniq"
    tag "pipeline"

    test("Kraken Uniq") {

        when {
            params {
                outdir = "$outputDir"
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(UTILS.removeNextflowVersion("$outputDir")).match("software_versions") },
                { assert snapshot(UTILS.filterLines("$outputDir/bbduk/2612_ERR5766176_B.bbduk.log", 1),
                                UTILS.filterLines("$outputDir/bbduk/2612_ERR5766176.bbduk.log", 1),
                                UTILS.filterLines("$outputDir/bbduk/2612_ERR5766180.bbduk.log", 1),
                                UTILS.filterLines("$outputDir/bbduk/2613_ERR5766181.bbduk.log", 1)).match("bbduk") },
                { assert snapshot(path("$outputDir/bowtie2/align/").list()).match("bowtie2/align/") },
                { assert snapshot(path("$outputDir/fastp/2612_ERR5766176_B.fastp.json"),
                                path("$outputDir/fastp/2612_ERR5766176.fastp.json"),
                                path("$outputDir/fastp/2612_ERR5766180.fastp.json"),
                                path("$outputDir/fastp/2613_ERR5766181.fastp.json")).match("fastp") },
                { assert snapshot(path("$outputDir/filtlong/").list()).match("filtlong") },
                { assert snapshot(UTILS.filterLines("$outputDir/krakenuniq/db6/2612.krakenuniq.report.txt", 1),
                                UTILS.filterLines("$outputDir/krakenuniq/db6/2613_ERR5766181.krakenuniq.report.txt", 1),
                                UTILS.filterLines("$outputDir/krakenuniq/db6/ERR3201952.krakenuniq.report.txt", 1),
                                UTILS.filterLines("$outputDir/krakenuniq/db6/ERX5474930_ERR5766174_1.krakenuniq.report.txt", 1)).match("krakenuniq") },
                { assert snapshot(path("$outputDir/multiqc/multiqc_data/bbduk.txt"),
                                path("$outputDir/multiqc/multiqc_data/filtlong.txt"),
                                path("$outputDir/multiqc/multiqc_data/multiqc_bowtie2.txt"),
                                path("$outputDir/multiqc/multiqc_data/multiqc_fastp.txt"),
                                path("$outputDir/multiqc/multiqc_data/multiqc_fastqc_1.txt"),
                                path("$outputDir/multiqc/multiqc_data/multiqc_fastqc.txt"),
                                path("$outputDir/multiqc/multiqc_data/multiqc_general_stats.txt"),
                                path("$outputDir/multiqc/multiqc_data/multiqc_samtools_stats.txt"),
                                path("$outputDir/multiqc/multiqc_data/porechop.txt")).match("multiqc") },
                { assert snapshot(UTILS.filterLines("$outputDir/porechop/ERR3201952_ERR3201952.log", -3)).match("porechop") },
                { assert snapshot(path("$outputDir/samtools/stats/").list()).match("samtools/stats/") },
                { assert snapshot(path("$outputDir/taxpasta/").list()).match("taxpasta") },
            )
        }

    }

}
