nextflow_pipeline {

    name "Test Workflow main.nf"
    script "main.nf"
    tag "test"
    tag "test_falco"
    tag "pipeline"

    test("Pre-Processing QC Tool - Falco") {

        when {
            params {
                outdir                = "$outputDir"
                preprocessing_qc_tool = "falco"
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(UTILS.removeNextflowVersion("$outputDir")).match("software_versions") },
                { assert new File("$outputDir/bbduk/2612_ERR5766176_B.bbduk.log").exists() },
                { assert new File("$outputDir/bbduk/2612_ERR5766176.bbduk.log").exists() },
                { assert new File("$outputDir/bbduk/2612_ERR5766180.bbduk.log").exists() },
                { assert new File("$outputDir/bbduk/2613_ERR5766181.bbduk.log").exists() },
                { assert snapshot(path("$outputDir/bowtie2/align/").list()).match("bowtie2/align/") },
                { assert snapshot(path("$outputDir/bracken/bracken_db1_combined_reports.txt")).match("bracken") },
                { assert snapshot(path("$outputDir/centrifuge/centrifuge_db3_combined_reports.txt")).match("centrifuge") },
                { assert new File("$outputDir/diamond/db1/2611_se_db1.diamond.tsv").exists() },
                { assert new File("$outputDir/diamond/db1/2612_se_db1.diamond.tsv").exists() },
                { assert new File("$outputDir/diamond/db1/2613_se_db1.diamond.tsv").exists() },
                { assert new File("$outputDir/diamond/db1/ERR3201952_se_db1.diamond.tsv").exists() },
                { assert snapshot(path("$outputDir/falco/processed/2612_ERR5766176_B_processed_falco_summary.txt"),
                                path("$outputDir/falco/processed/2612_ERR5766176_processed_falco_summary.txt"),
                                path("$outputDir/falco/processed/2612_ERR5766180_processed_falco_summary.txt"),
                                path("$outputDir/falco/processed/2613_ERR5766181_processed_falco_summary.txt"),
                                path("$outputDir/falco/processed/ERR3201952_ERR3201952_processed_falco_summary.txt"),
                                path("$outputDir/falco/raw/2612_ERR5766180_raw_falco_summary.txt"),
                                path("$outputDir/falco/raw/ERR3201952_ERR3201952_raw_falco_summary.txt")).match("falco") },
                { assert snapshot(path("$outputDir/fastp/2612_ERR5766176_B.fastp.json"),
                                path("$outputDir/fastp/2612_ERR5766176.fastp.json"),
                                path("$outputDir/fastp/2612_ERR5766180.fastp.json"),
                                path("$outputDir/fastp/2613_ERR5766181.fastp.json")).match("fastp") },
                { assert snapshot(path("$outputDir/filtlong/").list()).match("filtlong") },
                { assert new File("$outputDir/kaiju/kaiju_db5_combined_reports.txt").exists() },
                { assert snapshot(path("$outputDir/kraken2/kraken2_db1_combined_reports.txt"),
                                path("$outputDir/kraken2/kraken2_db2_combined_reports.txt")).match("kraken2") },
                { assert new File("$outputDir/krona/centrifuge_db3.html").exists() },
                { assert new File("$outputDir/krona/kaiju_db5.html").exists() },
                { assert new File("$outputDir/krona/kraken2_db1.html").exists() },
                { assert new File("$outputDir/krona/kraken2_db2.html").exists() },
                { assert new File("$outputDir/metaphlan3/metaphlan3_db4_combined_reports.txt").exists() },
                { assert snapshot(path("$outputDir/multiqc/multiqc_data/bbduk.txt"),
                                path("$outputDir/multiqc/multiqc_data/filtlong.txt"),
                                path("$outputDir/multiqc/multiqc_data/multiqc_bowtie2.txt"),
                                path("$outputDir/multiqc/multiqc_data/multiqc_fastp.txt"),
                                path("$outputDir/multiqc/multiqc_data/multiqc_fastqc_1.txt"),
                                path("$outputDir/multiqc/multiqc_data/multiqc_fastqc.txt"),
                                path("$outputDir/multiqc/multiqc_data/multiqc_kaiju_species.txt"),
                                path("$outputDir/multiqc/multiqc_data/multiqc_samtools_stats.txt"),
                                path("$outputDir/multiqc/multiqc_data/porechop.txt")).match("multiqc") },
                { assert snapshot(UTILS.filterLines("$outputDir/porechop/ERR3201952_ERR3201952.log", -3)).match("porechop") },
                { assert snapshot(path("$outputDir/samtools/stats/").list()).match("samtools/stats/") },
                { assert new File("$outputDir/taxpasta/bracken_db1.tsv").exists() },
                { assert new File("$outputDir/taxpasta/centrifuge_db3.tsv").exists() },
                { assert new File("$outputDir/taxpasta/diamond_db1.tsv").exists() },
                { assert new File("$outputDir/taxpasta/kaiju_db5.tsv").exists() },
                { assert new File("$outputDir/taxpasta/kraken2_db1.tsv").exists() },
                { assert new File("$outputDir/taxpasta/kraken2_db2.tsv").exists() },
                { assert new File("$outputDir/taxpasta/metaphlan_db4.tsv").exists() }
            )
        }

    }

}
